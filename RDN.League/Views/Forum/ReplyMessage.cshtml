@using RDN.League.Models.Forum
@model NewPost
@{
    ViewBag.Title = "Reply To " + Model.TopicTitle;
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<ol class="breadcrumb">
    <li><a href="@RDN.Library.Classes.Config.LibraryConfig.InternalSite">Home</a></li>
    <li><a href="@Url.Content("~/forum/posts/" + Model.ForumType + "/" + Model.ForumId.ToString().Replace("-", ""))">Forum</a></li>
    <li class="active">Reply To Post</li>
</ol>

<div class="row">
    <div class="col-xs-12 col-md-10 col-md-offset-1">
        <div class="panel panel-default">
            <div class="panel-heading">
                <div class="row">
                    <div class="col-xs-12 col-sm-8 col-lg-9">
                        <h4>Reply to </h4>
                        <h3 id="topicTitle" class="margin-top-5 margin-bottom-5"><b>@Model.TopicTitle</b></h3>
                        <span id="topicEditTitle" class="display-none ">
                            <input class="form-control margin-bottom-10" type="text" id="topicTitleEdit" placeholder="@Model.TopicTitle" />
                        </span>
                    </div>
                </div>
            </div>
            <div class="panel-body">



                @using (Html.BeginForm("ReplyMessage", "Forum", FormMethod.Post, new { onsubmit = "Forum.GetMentionedMembers()" }))
                {
                    <div class="panel panel-default" style="background-color:#fafafa">
                        <div class="panel-body padding-bottom-10 padding-top-10">
                            <div class="row">
                                                            <div class="col-xs-12 padding-15" style="background-color:white">
                                    @Html.TextArea("Message", string.Empty, new
                                {
                                    id = "wmd-input",
                                    style = "width:100%"
                                })
                                                                @Html.HiddenFor(x => x.Mentions, new { @id = "mentioned_members_ids" })
                                </div>
                                <div class="col-xs-12 col-sm-7 col-md-6 padding-top-10">
                                    @if (Model.ForumType != RDN.Portable.Classes.Forum.Enums.ForumOwnerTypeEnum.main)
                                    {
                                        <label>
                                            @Html.CheckBoxFor(x => x.BroadcastMessage)
                                            <span class="b">Broadcast this message </span><span class="i"> Entire group will be sent copy via email.</span> 
                                        </label>
                                    }
                                </div>
                                <div class="col-xs-12 col-sm-3 col-md-6 padding-top-10 text-right">
                                    <button class="btn btn-success" type="submit"><i class="fa fa-send"></i> Post Message</button>
                                    <a class="btn btn-default" href="@Url.Content("~/forum/post/view/" + Model.ForumId.ToString().Replace("-", "") + "/" + Model.TopicId)">Cancel</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    @Html.HiddenFor(x => x.ForumId)
                    @Html.HiddenFor(x => x.ForumType)
                    @Html.HiddenFor(x => x.TopicId)
                }
                @foreach (var message in Model.Messages)
                {
                    <div id="msg-@message.MessageId" class="panel panel-default" style="background-color:#fafafa">
                        <div class="panel-body padding-bottom-10 padding-top-10">
                            <div class="row">
                                <div class="col-xs-12 padding-bottom-10" style="border-bottom:#ddd dashed 1px">
                                    <div class="row">
                                        <div class="col-xs-12 col-md-6">
                                            <table>
                                                <tr>
                                                    <td>
                                                        @if (message.Member.Photos.Where(x => x.IsPrimaryPhoto == true).FirstOrDefault() != null)
                                                        {
                                                            <img height="65px" alt="@message.Member.Photos.Where(x => x.IsPrimaryPhoto == true).FirstOrDefault().Alt" src="@message.Member.Photos.Where(x => x.IsPrimaryPhoto == true).FirstOrDefault().ImageUrl" />
                                                        }
                                                        else
                                                        {
                                                            <img height="65px" src="@Url.Content("~/content/" + RDN.Library.Classes.Config.LibraryConfig.DefaultPictureName)" alt="default picture" />
                                                        }
                                                    </td>
                                                    <td class="padding-left-10">
                                                        @if (Model.ForumType == RDN.Portable.Classes.Forum.Enums.ForumOwnerTypeEnum.league)
                                                        {
                                                            <a target="_blank" href="@Url.Content("~/member/" + message.Member.MemberId.ToString().Replace("-", "") + "/" + RDN.Utilities.Strings.StringExt.ToSearchEngineFriendly(message.Member.DerbyName))">
                                                                <h4 class="no-margin-top">@message.Member.DerbyName</h4>
                                                            </a>
                                                        }
                                                        else
                                                        {
                                                            <a target="_blank" href="@Url.Content(RDN.Library.Classes.Config.LibraryConfig.PublicSite + "/" + RDN.Library.Classes.Config.LibraryConfig.SportNamePlusMemberNameForUrl + "/" + RDN.Utilities.Strings.StringExt.ToSearchEngineFriendly(message.Member.DerbyName) + "/" + message.Member.MemberId.ToString().Replace("-", ""))">
                                                                <h4>@message.Member.DerbyName</h4>
                                                            </a>
                                                        }
                                                        <span class="label label-danger">@message.Member.TotalForumPostsCount Posts</span>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-12 padding-top-10" style="background-color:white">
                                    @Html.Raw(message.MessageHTML)
                                </div>
                                <div class="col-xs-12 col-sm-7 col-md-6 padding-top-10">
                                    <a href="@Url.Content("~/forum/post/view/" + Model.ForumId.ToString().Replace("-", "") + "/" + Model.TopicId + "#msg-" + message.MessageId)"><i class="fa fa-clock-o"></i> @message.Created.ToLongDateString() @message.Created.ToShortTimeString()</a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

    </div>

    <div id="form_target" name="form_target" style="display:none"></div>

    <form id="img_form" action="/forum/postimageupload" method="post" enctype="multipart/form-data" style="width:0px;height:0;overflow:hidden">
        <input id="img_file" name="File" type="file">
        @Html.HiddenFor(x => x.ForumId, new { data_val = "false" })
        @Html.HiddenFor(x => x.ForumType, new { data_val = "false" })
        <input id="img_submit" type="submit" />
    </form> 
</div>
<script type="text/javascript">
    $(document).ready(function () {
        Forum.SetupPost("Forum", '@Model.ForumId', '@Model.ForumType', '@Model.TopicId', '@Model.GroupId');
    });
    $('#img_file').change(function (e) {
        var files = e.target.files;
        if (files.length > 0) {
            if (window.FormData !== undefined) {
                var data = new FormData($('#img_form')[0]);
                for (var x = 0; x < files.length; x++) {
                    data.append("file" + x, files[x]);
                }

                $.ajax({
                    type: "POST",
                    url: '/forum/postimageupload',
                    contentType: false,
                    processData: false,
                    data: data,
                    success: function (result) {
                        if (result.success) {
                            if (result.type == "document") {
                                tinyMCE.activeEditor.setContent(tinyMCE.activeEditor.getContent() + result.data);
                            }
                            else if (result.type == "image") {
                                $('#form_target').html(decodeURIComponent(result.data));
                            }
                        }
                        else {
                            //close the modal window
                            var ed = parent.tinymce.editors[0];
                            ed.windowManager.windows[0].close();
                            //show error message
                            $('.bottom-right').notify({
                                message: { text: result.message },
                                fadeOut: { enabled: true, delay: 4000 },
                                type: "danger"
                            }).show();
                        }
                    },
                    error: function (xhr, status, p3, p4) {
                        var err = "Error " + " " + status + " " + p3 + " " + p4;
                        if (xhr.responseText && xhr.responseText[0] == "{")
                            err = JSON.parse(xhr.responseText).Message;
                        console.log(err);
                    }
                });
            } else {
                alert("This browser doesn't support HTML5 file uploads!");
            }
        }
    });
</script>
